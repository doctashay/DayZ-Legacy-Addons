dbLoadHost;	//loads the hostname

DZ_spawnpass3params = [
  30.0,         // S3T_minDist2Zombie
  70.0,         // S3T_maxDist2Zombie
  25.0,         // S3T_minDist2Player
  70.0,         // S3T_maxDist2Player
   0.5,         // SPT_minDist2Static
   2.0          // SPT_maxDist2Static
];
DZ_spawnpointsfile = "spawnpoints_players.bin";

DZ_posbubbles = [
[ 11788.1 , 15096.7 , 0.00196075]  ,
[ 11671.7 , 15191.7 , 0.00157166]  ,
[ 11535 , 15157.8 , 0.00193787]  ,
[ 11901.8 , 13982.4 , 0.00131226]  ,
[ 11769.3 , 13944.6 , 0.00158691]  ,
[ 12454.3 , 13967.6 , 0.00115967]  ,
[ 14837.5 , 13280.4 , 0.00121665]  ,
[ 13640 , 13276.6 , 0.00173759]  ,
[ 13696.9 , 13456.7 , 0.00154495]  ,
[ 12858.1 , 10778.4 , 0.00114441]  ,
[ 12549.5 , 10785.7 , 0.00179291]  ,
[ 12432 , 11074.2 , 0.00178528]  ,
[ 12763.2 , 10418.7 , 0.00160599]  ,
[ 13225.5 , 10409 , 0.00114822]  ,
[ 12879.2 , 9221.08 , 0.00135088]  ,
[ 12944.4 , 8539.66 , 0.00123644]  ,
[ 13070.4 , 8139.25 , 0.00147104]  ,
[ 12964.7 , 7900.82 , 0.0018158]  ,
[ 13289.5 , 7201.04 , 0.0014286]  ,
[ 13255.5 , 6929.76 , 0.00157166]  ,
[ 13488.4 , 6407.87 , 0.00106621]  ,
[ 13244.3 , 6481.51 , 0.00134087]  ,
[ 13532.2 , 6183.14 , 0.0013845]  ,
[ 13432.2 , 5360.08 , 0.00137639]  ,
[ 12261.7 , 3447.58 , 0.00132036]  ,
[ 11935.4 , 3386.71 , 0.00132573]  ,
[ 11764.4 , 3367.28 , 0.00147438]  ,
[ 11063.1 , 2778.33 , 0.00137806]  ,
[ 10852.2 , 2379.6 , 0.000910044]  ,
[ 10742.8 , 2140.39 , 0.001387]  ,
[ 10457.6 , 1920.23 , 0.00166655]  ,
[ 9348.89 , 1902.39 , 0.00126934]  ,
[ 8564.98 , 2433.12 , 0.00142574]  ,
[ 8396.94 , 2623.65 , 0.00180507]  ,
[ 8001.04 , 3072.22 , 0.00144196]  ,
[ 7833.85 , 3234.81 , 0.00148296]  ,
[ 7582.88 , 3069.26 , 0.00169873]  ,
[ 7316.51 , 2685.99 , 0.00121832]  ,
[ 7265.08 , 2206.89 , 0.00136089]  ,
[ 6485.76 , 2216.71 , 0.00122213]  ,
[ 6711.99 , 2300.48 , 0.00143862]  ,
[ 6874.39 , 2328.78 , 0.00143862]  ,
[ 7014.36 , 2445.19 , 0.00143862]  ,
[ 7138.03 , 2642.62 , 0.00144815]  ,
[ 7633.02 , 3208.7 , 0.00155067]  ,
[ 7672.13 , 3189.19 , 0.00140429]  ,
[ 8012.11 , 3224.41 , 0.00153065]  ,
[ 8398.66 , 2985.91 , 0.00144243]  ,
[ 8315.54 , 2431.81 , 0.00141525]  ,
[ 8790.86 , 2401.31 , 0.00143528]  ,
[ 9448.84 , 1939.47 , 0.00123405]  ,
[ 9932.68 , 1631.04 , 0.00130033]  ,
[ 10396.3 , 1704.26 , 0.00143528]  ,
[ 10775.2 , 2242.1 , 0.00143623]  ,
[ 11749.3 , 3472.47 , 0.00217104]  ,
[ 11951.2 , 3530.81 , 0.00143862]  ,
[ 12018.3 , 3403.21 , 0.000889421]  ,
[ 12584.1 , 3535.61 , 0.00106812]  ,
[ 13008.8 , 3673.21 , 0.00124335]  ,
[ 13227 , 4008.35 , 0.00149822]  ,
[ 13508.5 , 4424.84 , 0.00145817]  ,
[ 13536.6 , 4714.61 , 0.00152731]  ,
[ 13315.6 , 4939.19 , 0.00204754]  ,
[ 13460.5 , 5233.57 , 0.00154066]  ,
[ 13342 , 5416.41 , 0.00143862]  ,
[ 13424.9 , 5751.18 , 0.00139523]  ,
[ 13604.1 , 6036.51 , 0.00163603]  ,
[ 13449.7 , 6643.37 , 0.00135887]  ,
[ 13342.1 , 6980.27 , 0.00141311]  ,
[ 13118.8 , 7801.86 , 0.00159514]  ,
[ 13131 , 8383.96 , 0.00122643]  ,
[ 12723.8 , 8751.47 , 0.00159836]  ,
[ 13235.3 , 10388.1 , 0.00140333]  ,
[ 13489.5 , 10982.5 , 0.00147533]  ,
[ 13873.5 , 11301.5 , 0.00193787]  ,
[ 13848.8 , 11733.1 , 0.00146484]  ,
[ 14172 , 12230.7 , 0.00145102]  ,
[ 14201.1 , 12696.6 , 0.00139499]  ,
[ 14331.6 , 12984.5 , 0.00144958]  ,
[ 13102.7 , 7913.37 , 0.00137544]  ,
[ 11963.9 , 13671.1 , 0.00162506]  ,
[ 12174.9 , 13528.5 , 0.00173187]  ,
[ 12368.5 , 13982.6 , 0.00121307]  ,
[ 12664.7 , 14198.2 , 0.00144386]  ,
[ 11232.5 , 14176.4 , 0.0014267]  ,
[ 11361.1 , 14782.4 , 0.0020752]
  ];

_createPlayer = 
{
	//check database
	
	diag_log format["CONNECTION: _id: %1 _uid: %2 _name: %3",_id,_uid,_name];
	
	_savedChar = dbFindCharacter _uid;
	_isAlive = _savedChar select 0;
	_isOnline = _savedChar select 1;
	_pos = [_savedChar select 2,_savedChar select 3,_savedChar select 4];
	_idleTime = _savedChar select 5;
	
	if (!_isOnline) then
	{
		diag_log format["WARNING: No connection to HIVE. Player %1 could not be loaded.",_uid];
	};
	
	//process client
	[_id,_isAlive,_pos,overcast,rain,_isOnline,_idleTime] spawnForClient {
		titleText ["","BLACK FADED",10e10];
		diag_log str(_this);
		playerQueueVM = _this call player_queued;
	};
};

//DISCONNECTION PROCESSING
_disconnectPlayer =
{
	if (!isNull _agent) then
	{	
		if (vehicle _agent != _agent) then
		{
			//_agent action ["eject", vehicle _agent]; 
			moveOut _agent;
		};
		call dbSavePlayer;
		_vm = [_uid,_agent] spawn 
		{
			_uid = _this select 0;
			_agent = _this select 1;
			_connected = diag_tickTime - (_agent getVariable ["starttime",diag_tickTime]);
			diag_log format ["DISCONNECT: Player %1 agent %2 after %3 seconds",_uid,_agent,_connected];
			_hands = itemInHands _agent;
			_vs = DBSetQueue [_uid,33]; // 33 sec default queue for disconnecting
			sleep 1;
			_agent playAction "SitDown";		
			sleep 30;		
			call dbSavePlayer;
			if (alive _agent) then
			{
				/*
				if (!isNull _hands) then
				{
					moveToGround _hands;
					deleteVehicle _hands;
				};
				*/
				deleteVehicle _agent;
			};
		};
	};
};

// Create player on connection
onPlayerConnecting _createPlayer;
onPlayerDisconnected _disconnectPlayer;
/*
"CLIENT request to respawn ["respawn",SurvivorPartsMaleWhite:2:11874] (UNCONSCIOUS)"
WARNING: Function 'name' - Hicks_206 is dead
WARNING: Function 'name' - Hicks_206 is dead
"Player Hicks_206 was killed by Hicks_206"
Saving array to database: type Any is not supported
"CLIENT 3 request to spawn ["clientNew",[7,[1,0,0],3]]"
"CLIENT 3 spawn request rejected as already alive character"

*/


"clientReady" addPublicVariableEventHandler
{
	_vm = _this spawn {
		_id = _this select 1;
		_uid = getClientUID _id;

		_wait = (dbFindCharacter _uid) select 5;
		_wait = (-_wait) max 0;
		diag_log format["Player %1 ready to load previous character, waiting %2 seconds",_uid,_wait];
		sleep _wait;
		_handler = 
		{ 
			if (isNull _agent) then 
			{ 
				//this should never happen!
				diag_log format["Player %1 has no agent on load, kill character",_uid];
				_id statusChat ["Your character was unable to be loaded and has been reset. A system administrator has been notified. Please reconnect to continue.","ColorImportant"];
				dbKillCharacter _uid;
			}
			else
			{
				call init_newBody;
			};
		}; 
			_id dbServerLoadCharacter _handler;



	};
};

"respawn" addPublicVariableEventHandler
{
	_agent = _this select 1;
	
	diag_log format ["CLIENT request to respawn %1 (%2)",_this,lifeState _agent];
	
	if (lifeState _agent != "ALIVE") then
	{
		//get details
		_id = owner _agent;
		_uid = getClientUID _id;
		_agent setDamage 1;
		dbKillCharacter _uid;
		
		diag_log format ["CLIENT killed character %1 (clientId %2 / Unit %2)",_uid,_id,lifeState _agent];
		
		//process client
		[_id,false,position _agent,overcast,rain,true,-30] spawnForClient {
			titleText ["Respawning... Please wait...","BLACK FADED",10e10];
			diag_log str(_this);
			playerQueueVM = _this call player_queued;
		};
	};
};

"clientNew" addPublicVariableEventHandler
{
	_array = _this select 1;
	_id = _array select 2;
	diag_log format ["CLIENT %1 request to spawn %2",_id,_this];
	_id spawnForClient {statusChat ['testing 1 2 3','']};
	
	_savedChar = dbFindCharacter (getClientUID _id);
	if (_savedChar select 0) exitWith {
		diag_log format ["CLIENT %1 spawn request rejected as already alive character",_id];
	};
		
	_charType = _array select 0;
	_charInv = _array select 1;
    _spawnPos = DZ_posbubbles select (floor (random (count DZ_posbubbles))); 
    _pos = [_spawnPos select 0, _spawnPos select 1, _spawnPos select 2]; 
	//_pos = [3590.96,8492.23,0];
	
	//load data
	_top = getArray(configFile >> "cfgCharacterCreation" >> "top");
	_bottom = getArray(configFile >> "cfgCharacterCreation" >> "bottom");
	_shoe = getArray(configFile >> "cfgCharacterCreation" >> "shoe");
	
	_myTop = _top select (_charInv select 0);
	_myBottom = _bottom select (_charInv select 1);
	_myShoe = _shoe select (_charInv select 2);
	_mySkin = DZ_SkinsArray select _charType;
	
	_uid = getClientUID _id;
	_res1 = dbCreateCharacter _uid;
	
	diag_log format["SERVER: Creating %1 at %2 for clientId %3 (DB result %4)",_mySkin,_pos,_id,_res1];
	
	_agent = createAgent [_mySkin,  _pos, [], 0, "NONE"];
	_agent = createAgent [_mySkin,  _pos, [], 0, "NONE"];
	{null = _agent createInInventory _x} forEach ["TTsKO_Jacket_Camo","TTsKO_Pants_Camo","MilitaryBoots_Bluerock"];
	// _v = _agent createInInventory "TTsKO_Jacket_Camo";
	// _v = _agent createInInventory "TTsKO_Pants_Camo";
	// _v = _agent createInInventory "MilitaryBoots_Bluerock";
	_v = _agent createInInventory "BagMountain_Blue";
	_v = _agent createInInventory "UKAssVest_Black";
	_v = _agent createInInventory "SKS_Black";
	_v = _agent createInInventory "BallisticHelmet_Black";
	_v = _agent createInInventory "FirefighterAxe_Black";
	_v = _agent createInInventory "tool_flashlight";
	_v = _agent createInInventory "Consumable_Battery9V";_v setVariable ["QUANTITY",100];
	_v = _agent createInInventory "Medical_Bandage";_v setVariable ["quantity",100];
	_v = _agent createInInventory "Light_PortableLamp";
	_v = _agent createInInventory "Consumable_GasCanisterSmall";_v setVariable ["quantity",100];
	_v = _agent createInInventory "CombatKnife";
	_v = _agent createInInventory "TentMedium_Packed";
	_v = _agent createInInventory "CLIP_762x39_10Rnd";
	_v = _agent createInInventory "Tools_Handcuffs";
	_v = _agent createInInventory "Tools_Handcuffs";
	_v = _agent createInInventory "Tools_HandcuffKeys";
	_v = _agent createInInventory "Fireplace_Unprepared";
	_v = _agent createInInventory "Tool_SewingKit";
	//_v = _agent createInInventory "Att_Handguard_MP";
	//_v = _agent createInInventory "Att_Optic_ACOG";
	//_v = _agent createInInventory "MiscItem_HeatPack";_v setVariable ["amount",100];
	_v = _agent createInInventory "Consumable_Chemlight_White";_v setVariable ["quantity",100];
	//_v = _agent createInInventory "Fireplace_Prepared";
	_v = _agent createInInventory "Ammo_762x39_20Rnd";
	_v = _agent createInInventory "Crafting_WoodenStick";_v setVariable ["quantity",3];
	_v = _agent createInInventory "Consumable_Rags";_v setVariable ["quantity",3];
	_v = _agent createInInventory "Consumable_Matchbox";_v setVariable ["quantity",100];
	_v = _agent createInInventory "Meat_ChickenBreast_Cooked";_v setVariable ["amount",100];
	_agent call init_newPlayer;
	call init_newBody;
	
	diag_log format["SERVER: Created %1 for clientId %2",_agent,_id];
};
